<!--
title: Configuration de la partie Boite Aux Lettres (BAL)
description: Configuration BAL
published: true
date: 2023-02-15T17:38:09.088Z
tags: 
editor: ckeditor
dateCreated: 2021-05-24T10:35:39.397Z
-->

<figure class="image image_resized" style="width:22.66%;"><img src="/images/exchange2016_logo.png">
  <figcaption><strong>Auteur : Antoine JOVELIN</strong><br><strong>Admin Système Réseau - 49100 Angers</strong><br><strong>Source :</strong> <a href="https://wiki.jovelinantoine.fr/">wiki.jovelinantoine.fr</a></figcaption>
</figure>
<h1>Configuration d’un domaine accepté</h1>
<ul>
  <li>Qu’est-ce qu’un domaine accepté</li>
</ul>
<p>Un domaine accepté est un <strong>espace de noms SMTP</strong> (également appelé espaces d’adressage) qui sera configuré dans une organisation Exchange afin d’envoyer et de recevoir des messages électroniques pour ce même espace de nom SMTP.&nbsp;<br>Il est obligatoire de configurer un domaine accepté</p>
<ul>
  <li>Pourquoi ajouter un domaine accepté</li>
</ul>
<p>Le serveur <strong>Exchange acceptera de traiter les emails pour cet espace de nom</strong> car il en aura la «&nbsp;responsabilité&nbsp;».<br>Sans cette configuration le serveur ne traitera pas les messages électroniques reçus ou envoyés par cet espace de noms SMTP.</p>
<ul>
  <li>Les types de domaines acceptés</li>
</ul>
<h2>Domaine faisant autorité</h2>
<p><strong>Tous les destinataires</strong> figurant dans le domaine faisant autorité <strong>existent dans l'organisation Exchange</strong>.<br>Exchange est chargé de générer des <strong>notifications d'échec</strong> de remise (également appelées notifications de non-remise) pour les destinataires ne figurant pas dans un domaine faisant autorité.<br>Le serveur <strong>Exchange est donc totalement «&nbsp;maître&nbsp;» de ce domaine</strong> et en aura une totale responsabilité.<br>L’intégralité des boites mails du domaine sera gérée par le serveur Exchange de l’entreprise.</p>
<p>Il est possible d’avoir plusieurs domaines faisant autorité dans la même organisation.</p>
<h2>Domaine de relais interne</h2>
<p>C<strong>ertains destinataires dans le domaine de relais interne peuvent exister dans l'organisation Exchange</strong> mais ce n’est pas le cas de tous les destinataires.<br>Exchange n'est <strong>pas chargé de générer des notifications d'échec</strong> de remise pour les destinataires ne figurant pas dans un domaine de relais interne. Pour avoir des notifications, il faudra créer un connecteur d'envoi avec l'espace d'adressage du domaine de relais interne. Il faudra également approvisionner ce connecteur d'envoi sur un serveur de boîtes aux lettres interne pour relayer les messages destinés aux destinataires absents du domaine.<br>Cette configuration <strong>permettra de relayer les e-mails en interne</strong> vers des destinataires internes ne faisant pas parti de l’organisation Exchange de l’entreprise.<br>Une partie des boites mails est gérée par le serveur Exchange, si toutefois certains destinataires font partie de l’organisation Exchange de l’entreprise.</p>
<h2>Domaine de relais externe</h2>
<p><strong>Aucun des destinataires figurant dans le domaine de relais externe n'existe dans l'organisation Exchange</strong>.<br>Exchange <strong>n'est pas chargé de générer des notifications d'échec</strong> de remise pour les destinataires ne figurant pas dans un domaine de relais externe.<br>Pour avoir des notifications, il faudra créer un connecteur d'envoi avec l'espace d'adressage du domaine de relais externe.<br>Il faudra également approvisionner ce connecteur d'envoi sur un <strong>serveur de transport Edge</strong> ou un serveur de boîtes aux lettres connecté à Internet pour relayer les messages destinés aux destinataires absents du domaine.<br>Cette configuration permettra de relayer les e-mails vers des destinataires externes de l’entreprise ne faisant pas parti de l’organisation Exchange de l’entreprise.<br>Aucune des boites mails n’est gérée par le serveur Exchange.</p>
<ul>
  <li>Les domaines acceptés se <strong>configurent de deux manières</strong> différentes</li>
</ul>
<p><u>Depuis l’EAC</u></p>
<p>Se connecter à l’EAC puis se rendre dans la partie flux de messagerie et enfin cliquer sur domaines acceptés</p>
<figure class="image"><img src="/images/eac-2.png"></figure>
<p>Cliquer sur le symbole <span class="text-huge"><strong>+ </strong></span>puis remplir les informations demandées</p>
<figure class="image image_resized" style="width:60%;"><img src="/images/eac-3.png"></figure>
<p>Valider en cliquant sur enregistrer.</p>
<p><u>Depuis PowerShell avec la commande suivante&nbsp;:</u></p>
<pre><code class="language-plaintext">New-AcceptedDomain -Name «nom_FQDN_du_domaine» -DomainName «nom_FQDN_du_domaine» -DomainType «type_du_domaine» </code></pre>
<h1>Les stratégies d’adresses de messagerie</h1>
<ul>
  <li>Qu’est-ce qu’une stratégie d’adresse de messagerie</li>
</ul>
<p>Une stratégie d’adresse de messagerie permet de <strong>configurer l’adresse par défaut qu’aura un certain groupe de personne</strong>.<br>Elle <strong>définit les règles qui créent des adresses</strong> de messagerie de destinataires dans l’ organisation Exchange.</p>
<ul>
  <li>Pourquoi en configurer</li>
</ul>
<p>Permet d’attribuer automatiquement des adresses mails d’un certain type à certaines types ou groupes d’utilisateurs.</p>
<ul>
  <li>Les types de stratégies</li>
</ul>
<p><u>Adresse de messagerie SMTP prédéfinie</u></p>
<p>Il s’agit d’<strong>adresses par défaut proposées par Exchange</strong> en fonction du domaine créé.</p>
<p><u>Adresse de messagerie SMTP personnalisée</u></p>
<p>Il s’agit de la <strong>personnalisation des adresses de messageries</strong> de l’organisation.</p>
<p><u>Adresse de messagerie NON SMTP</u></p>
<ul>
  <li>A qui l’appliquer</li>
</ul>
<p>Les stratégies <strong>s’appliquent à un groupe de destinataires</strong> correspondant à différents critères de filtrages afin de définir leur adresse de messagerie selon les besoins.</p>
<ul>
  <li>Comment la configurer</li>
</ul>
<p><u>Via l’ECA</u></p>
<p><u>Via Exchange Management Shell (EMS)</u></p>
<p>&nbsp;</p>
<p>Pour créer la stratégie d’adresse&nbsp;:&nbsp;<br>&nbsp;</p>
<pre><code class="language-plaintext">New-EmailAddresspolicy -Name «nom_de_la_stratégie» -IncludedRecipients MailboxUsers -EnabledEmailAddressTemplates «SMTP:%g.%.%s@domaine.com»</code></pre>
<p>Pour appliquer la stratégie d’adresse&nbsp;:&nbsp;<br>&nbsp;</p>
<pre><code class="language-plaintext">Update-EmailAddressPolicy -Identity «nom_de_la_stratégie»</code></pre>
<p><mark class="pen-red"><strong>Attention</strong>&nbsp;: </mark><i><mark class="pen-red">il faut laisser les guillemets dans la ligne de commande</mark></i></p>
<p><u>Exemple d’application d’une stratégie&nbsp;:&nbsp;</u></p>
<ul>
  <li>Via l’EAC&nbsp;:</li>
</ul>
<p>Dans le cas où le domaine serai du type «&nbsp;domaine.local&nbsp;» et que l’on souhaite que les utilisateurs utilisent l’adresse de messagerie du domaine externe qui lui est du type «&nbsp;domaine.com&nbsp;», il faudra <strong>rajouter un suffixe UPN</strong> <strong>dans la configuration AD</strong>.<br>Cela permettra aux utilisateurs de se <strong>connecter directement dans Outlook avec leur adresse externe</strong> en «&nbsp;domaine.com&nbsp;»<br>Puis une fois cette manipulation faite, créer une stratégie de messagerie pour que tous les utilisateurs utilisent l’adresse en «&nbsp;domaine.com&nbsp;».</p>
<p>Pour effectuer cette configuration il faut se rendre dans «&nbsp;<strong>domaines et approbations Active Directory</strong>&nbsp;» puis faire un clic droit/propriété sur le dossier domaines et approbations Active Directory.&nbsp;</p>
<figure class="image image_resized" style="width:51.81%;"><img src="/images/dom_approb-1.png"></figure>
<p>Puis ajouter le <strong>suffixe UPN</strong> «&nbsp;domaine.com&nbsp;»</p>
<figure class="image"><img src="/images/dom_approb-2.png"></figure>
<p><mark class="pen-red"><strong>Attention</strong>&nbsp;: </mark><i><mark class="pen-red">Cette configuration est également à faire lors d’une configuration Exchange hybride (On-Premise ET Cloud)</mark></i></p>
<p>Il reste maintenant à créer la stratégie d’adresse pour que tous les utilisateurs de l’organisation utilisent l’adresse de messagerie externe.<br>Pour cela il faut se connecter à l’EAC puis aller dans «&nbsp;<strong>flux de messagerie</strong>&nbsp;» et cliquer sur «&nbsp;<strong>stratégies d’adresse de messagerie</strong>&nbsp;»</p>
<figure class="image"><img src="/images/eac-4.png"></figure>
<p>Cliquer sur le symbole <span class="text-huge"><strong>+ </strong></span>pour ajouter une stratégie</p>
<figure class="image"><img src="/images/eac-5.png"></figure>
<p>Cliquer à nouveau sur le <span class="text-huge"><strong>+&nbsp;</strong></span></p>
<figure class="image"><img src="/images/eac-6.png"></figure>
<p>Toujours sur la même fenêtre, descendre le curseur pour définir à qui appliquer cette stratégie</p>
<figure class="image"><img src="/images/eac-7.png"></figure>
<p>Une fois la stratégie est créée il faut <strong>IMPÉRATIVEMENT</strong> l’appliquer.</p>
<figure class="image"><img src="/images/eac-8.png"></figure>
<p><mark class="pen-red"><strong>Attention</strong>&nbsp;: </mark><i><mark class="pen-red">Toute stratégie créée mais non appliquée ne sera pas prise en compte dans la configuration</mark></i></p>
<ul>
  <li>Via Exchange Management Shell (EMS)</li>
</ul>
<figure class="image"><img src="/images/ems-4.png"></figure>
<p><strong>New-EmailAddresspolicy</strong>&nbsp;: indique la création d’une nouvelle stratégie</p>
<ul>
  <li><strong>Name «nom_de_la_stratégie»</strong>&nbsp;:indique le nom de la stratégie</li>
  <li><strong>IncludedRecipients MailboxUsers</strong>&nbsp;: indique à qui sera appliqué cette stratégie (ici tous les utilisateurs de boites de messagerie)</li>
  <li><strong>EnabledEmailAddressTemplates «SMTP:%g.%.%s@domaine.com</strong>»&nbsp;: indique le format de l’adresse de messagerie (ici prenom.nom@domaine.com)</li>
</ul>
<p>Pour vérifier si la stratégie a bien été créée il faut taper la commande suivante&nbsp;</p>
<pre><code class="language-plaintext">Get-EmailAdresspolicy</code></pre>
<p>&nbsp;</p>
<figure class="image"><img src="/images/ems-5.png"></figure>
<p>Il ne reste plus qu’à appliquer la stratégie&nbsp;</p>
<pre><code class="language-plaintext">Update-EmailAddressPolicy -Identity «nom_de_la_stratégie»</code></pre>
<p>&nbsp;</p>
<figure class="image"><img src="/images/ems-6.png"></figure>
<h2>Base de données de boites aux lettres</h2>
<p><u>Bref rappel du fonctionnement de la réception d’un e-mail&nbsp;:</u></p>
<ul>
  <li>Un e-mail est reçu par le serveur</li>
  <li>Le serveur traite le mail s’il est pour un domaine accepté.et va remettre remet le message.</li>
  <li>Dans le cas d’une boite aux lettres hébergée par le serveur, dans un 1<sup>er</sup> temps le serveur dépose le mail dans la RAM et en même temps dans les logs (fichier .log&nbsp; qui sont des logs de transaction). Dans un 2eme temps il l’écrit dans le fichier «&nbsp;.edb&nbsp;» qui est en réalité la BDD</li>
  <li>Une fois écrit dans la BDD, le serveur écrit dans les logs de check «&nbsp;.chk&nbsp;» qui servent à valider l’écriture en BDD</li>
  <li>Pour finir, l’utilisateur pourra voir le mail dans sa boite aux lettres.</li>
</ul>
<figure class="image"><img src="/images/schema_bdd_mailbox.png"></figure>
<p><strong>Attention</strong>&nbsp;: <i>Tant que la vérification via le «&nbsp;.chk&nbsp;» n’a pas été faite, l’utilisateur ne pourra pas voir le mail et ce même s’il a été positionné précédemment par le serveur dans sa boite aux lettres dans la BDD</i>&nbsp;</p>
<h3>La composition d’une base de données</h3>
<p>Une base de données de boite aux lettres est une base de données qui va stocker les boites aux lettres des utilisateurs, avec par exemple les mails, les contacts, le calendrier etc.<br>Une base de données de boite aux lettres est composée des éléments suivants&nbsp;:</p>
<ul>
  <li>Fichier «&nbsp;tmp.edb&nbsp;»</li>
</ul>
<p>Il s’agit de fichiers temporaires&nbsp;</p>
<ul>
  <li>Fichier «&nbsp;.edb&nbsp;»</li>
</ul>
<p>La base de données de boite aux lettres</p>
<ul>
  <li>Fichier «&nbsp;.log&nbsp;»</li>
</ul>
<p>Les journaux de transactions&nbsp;</p>
<ul>
  <li>Fichier «&nbsp;.chk&nbsp;»</li>
</ul>
<p>Point de contrôle</p>
<ul>
  <li>Fichiers «&nbsp;E##res0001.jrs – E##res000A.log&nbsp;»</li>
</ul>
<p>Fichiers de journaux de réserve&nbsp;</p>
<h3>Personnalisation de la base de données</h3>
<p>Il existe de <strong>nombreux éléments</strong> des bases de données qui peuvent être <strong>personnalisés</strong>.<br>Voici un exemple des éléments principaux&nbsp;:</p>
<ul>
  <li>Taille de la base de données</li>
</ul>
<p>Il est possible de définir la taille maximum de la base de données. De plus, il est conseillé que le stockage de la BDD soit différent de celui pour l’OS</p>
<ul>
  <li>Le quota de la boite aux lettres</li>
</ul>
<p>Permet de définir la taille maximum d’une boite aux lettres utilisateur.</p>
<ul>
  <li>La période de rétention des éléments et des boites aux lettres supprimées</li>
</ul>
<p>Permet de définir la période durant laquelle les éléments supprimés ou les boites aux lettres supprimées pourront être accessibles avant d’être supprimé définitivement.</p>
<ul>
  <li>Le carnet d’adresses</li>
</ul>
<p>Il est possible de faire créer un carnet d’adresse par site géographique (par exemple une BDD avec toutes les boites de Paris permettra de créer un carnet d’adresse «&nbsp;Paris&nbsp;»)</p>
<ul>
  <li>Les logs circulaires</li>
</ul>
<p>Il s’agit des fichiers «&nbsp;.log&nbsp;» détaillés plus haut.</p>
<p>Il est conseillé de mettre un système de sauvegarde, de purge et une taille maximum des logs car ces derniers grossissent souvent et rapidement. Dans le cadre d’un DAG cette configuration est vivement conseillée.</p>
<ul>
  <li>Le montage automatique de la base de données</li>
</ul>
<p>Il est possible de configurer le montage automatique des BDD. Par exemple, au redémarrage d’un serveur les bases de données seront remontées automatiquement évidement de le faire manuellement et permettant que les BDD soient utilisables.</p>
<ul>
  <li>L’activation d’indexation</li>
</ul>
<p>Cette configuration permettra de créer un index pour chaque données dans les boites aux lettres facilitant et améliorant les recherches.</p>
<h3>Comment administrer les bases de données</h3>
<p><u>Via l’EAC</u></p>
<p>La liste des bases de données se trouve dans la partie «&nbsp;<strong>serveur</strong>&nbsp;» puis «&nbsp;<strong>base de données</strong>&nbsp;».</p>
<figure class="image"><img src="/images/eac-9.png"></figure>
<p>Pour ajouter une base de données cliquer sur <span class="text-huge"><strong>+ </strong></span>et remplir les champs nécessaires</p>
<figure class="image"><img src="/images/eac-10.png"></figure>
<p>Une fois la BDD créée, elle sera visible dans la liste.&nbsp;</p>
<figure class="image"><img src="/images/eac-11.png"></figure>
<p>Pour <strong>personnaliser la BDD</strong> faire un <strong>double clic</strong> dessus et toutes les configurations là concernant seront visibles.</p>
<figure class="image"><img src="/images/eac-12.png"></figure>
<p><mark class="pen-red"><strong>Attention</strong>&nbsp;: </mark><i><mark class="pen-red">Penser à redémarrer le service Exchange Information Store (banque d’information).</mark></i><br><i>Nécessite un compte avec les droits adaptés</i></p>
<p><u>Via Exchange Management Shell (EMS)</u></p>
<ul>
  <li>Création d’une base de données&nbsp;:</li>
</ul>
<pre><code class="language-plaintext">New-MailboxDatabase -Name «nom_de_la_base» -EdbFilePath «Chemin_du_stockage_de_la_BDD\nom_de_la_base.edb» -LogFolderpath «Chemin_du_stockage_des_logs»</code></pre>
<p><mark class="pen-red"><strong>Attention</strong>&nbsp;: </mark><i><mark class="pen-red">il faut laisser les guillemets dans la ligne de commande</mark></i></p>
<ul>
  <li>Personnaliser la base de données</li>
</ul>
<pre><code class="language-plaintext">Set-MailboxDatabase</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Voir les informations de configuration de la base de données</li>
</ul>
<pre><code class="language-plaintext">Get-MailboxDatabase</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Démonter une base de données</li>
</ul>
<pre><code class="language-plaintext">Dismount-Database</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Monter une base de données</li>
</ul>
<pre><code class="language-plaintext">Mount-Database</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Modifier le chemin de stockage d’une base de données</li>
</ul>
<pre><code class="language-plaintext">Move-DatabasePath</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Création d’une base de données «&nbsp;dossier publique&nbsp;» (attention depuis Exchange 2013 il ne s’agit pas d’une NDD à part entière mais d’une boite aux lettres)</li>
</ul>
<pre><code class="language-plaintext">New-Mailbox -PublicFolder -Name «nom_de_la_mailbox»</code></pre>
<p><mark class="pen-red"><strong>Attention</strong>&nbsp;: </mark><i><mark class="pen-red">il faut laisser les guillemets dans la ligne de commande. De plus, après n’importe laquelle de ces commandes, penser à redémarrer le service Exchange Information Store (banque d’information). Nécessite un compte avec les droits adaptés</mark></i></p>
<h2>Les destinataires de messagerie</h2>
<h3>Définition</h3>
<p>Les destinataires de messagerie électronique Exchange sont tous <strong>des objets de l’Active Directory</strong>, qu’il s’agisse de <strong>personnes physiques ou de ressources&nbsp;</strong>(salles, matériels ,etc.).<br>Tous ces objets ont une <strong>extension de messagerie</strong> <strong>permettant de délivrer ou de router des messages électroniques</strong>.</p>
<h3>Les types de destinataires</h3>
<p><u>Il existe plusieurs types de destinataires&nbsp;:</u></p>
<ul>
  <li>Boites aux lettres utilisateurs (aussi appelé «&nbsp;utilisateur à extension de boite aux lettres&nbsp;»)</li>
</ul>
<p>Il s’agit d’une boite aux lettres INDIVIDUELLE pour un <strong>seul utilisateur</strong>.<br>Nécessite une licence CAL</p>
<ul>
  <li>Contacts de messagerie</li>
</ul>
<p>Il s’agit d’un <strong>objet qui est dans l’annuaire Active Directory</strong> possédant des attributs de messagerie Exchange mais <strong>qui ne fait pas parti de l’organisation de l’entreprise</strong>. Chaque contact de messagerie dispose d'une <strong>adresse de messagerie externe</strong>. Tous les messages envoyés au contact de messagerie sont routés à cette adresse de messagerie externe.<br>La boite aux lettres n’est pas stockée dans les serveurs Exchange de l’entreprise.<br>Il ne sera pas possible à ce contact de se connecter au domaine Active Directory avec le compte AD.<br>Cela permet de référencer des personnes externe dans l’organisation Exchange.</p>
<ul>
  <li>Utilisateurs de messagerie (aussi appelé «&nbsp;utilisateur à extension de messagerie&nbsp;»)</li>
</ul>
<p><strong>Utilisateur Active Directory</strong> à extension de messagerie qui représente un <strong>utilisateur extérieur</strong> à l'organisation Exchange. Chaque utilisateur de messagerie dispose d'une <strong>adresse de messagerie externe</strong>. Tous les messages envoyés à l'utilisateur de messagerie sont routés à cette adresse de messagerie externe.<br>Un utilisateur de messagerie est semblable à un contact de messagerie, sauf qu'un utilisateur de messagerie dispose d'informations d'identification <strong>d'ouverture de session Active Directory</strong> et peut <strong>accéder aux ressources</strong>.</p>
<ul>
  <li>Boites aux lettres de ressources</li>
</ul>
<p>Il s’agit d’une <strong>boite aux lettres affectée à une ressource</strong> qui n’est pas propre à un emplacement, telle qu’un projecteur, un ordinateur portable, un microphone ou un véhicule de société, etc. Ces <strong>ressources peuvent alors être réservées</strong> par les utilisateurs de l’entreprise en les incluant comme ressources dans les demandes de réunions.</p>
<ul>
  <li>Boites aux lettres partagées</li>
</ul>
<p>Il s’agit d’une <strong>boite aux lettres commune et partagée pour différentes personnes</strong> comme par exemple un même service.<br>Ces personnes pourront se connecter à cette boite et également envoyer des messages électroniques s’ils en ont les droits.<br>Ce type de boite aux lettres ne nécessite pas une licence CAL.</p>
<ul>
  <li>Groupes de sécurité à extension de messagerie</li>
</ul>
<p>Un groupe de sécurité à extension messagerie est un <strong>objet de</strong> <strong>groupe universel de sécurité Active Directory</strong> qui peut être utilisé pour <strong>affecter des autorisations d'accès à des ressources dans Active Directory</strong> et qui peut également être utilisé pour <strong>distribuer des messages.</strong></p>
<ul>
  <li>Groupes de distribution</li>
</ul>
<p>Un groupe de distribution est un <strong>groupe Active Directory à extension messagerie</strong> qui peut être uniquement utilisé pour <strong>distribuer des messages à un groupe de destinataires.</strong></p>
<ul>
  <li>Groupes de distribution dynamiques</li>
</ul>
<p>Groupe de distribution qui <strong>utilise des filtres des destinataires</strong> <strong>et des conditions</strong> pour déterminer son appartenance lors de l'envoi des messages.</p>
<ul>
  <li>Boites aux lettres liées</li>
</ul>
<p>Boîte aux lettres affectée à un <strong>utilisateur individuel dans une forêt approuvée distincte</strong> (c’est-à-dire dans une autre forêt que cette de l’organisation de l’entreprise).</p>
<figure class="image"><img src="/images/linked_mailbox.png"></figure>
<ul>
  <li>Boites aux lettres Office365 (standard ou hybride)</li>
</ul>
<p>Dans les déploiements hybrides, une boîte aux lettres Office 365 est composée d'un &nbsp;<strong>utilisateur de messagerie existant dans Active Directory version locale </strong>et <strong>une boîte aux lettres existant dans Exchange Online.</strong></p>
<ul>
  <li>Boites aux lettres de sites</li>
</ul>
<p>Boîte aux lettres constituée d'une <strong>boîte aux lettres Exchange&nbsp;</strong>pour stocker les messages électroniques et d'un <strong>site SharePoint&nbsp;</strong>pour stocker des documents. Les utilisateurs peuvent accéder aux messages électroniques et aux documents à l'aide d'une même interface client.</p>
<figure class="image"><img src="/images/site_mailbox.png"></figure>
<ul>
  <li>Dossier public à extension messagerie</li>
</ul>
<p><strong>Dossier public</strong> Exchange configuré pour recevoir des messages.</p>
<p><u>Le principe de fonctionnement pour un utilisateur est le suivant&nbsp;:&nbsp;</u></p>
<p>Dans le domaine Active Directory, il y a des comptes utilisateurs permettant aux différentes personnes de se connecter et de s’authentifier aux différents postes de l’entreprise.&nbsp;<br>Pour leur rajouter une boite aux lettres, il va falloir la créer dans Exchange et elle sera stockées dans la base de données de boites aux lettres Exchange.<br>Lors de la création de cette boite aux lettres, une liaison avec le compte Active Directory de l’utilisateur sera faite, permettant alors à cet utilisateur de se connecter à la boite aux lettres lui étant destinée.</p>
<figure class="image"><img src="/images/public_folder.png"></figure>
<h3>Administration des destinataires de messagerie</h3>
<p>Encore une fois il est possible de faire l’administration des destinataires de messagerie de deux façon&nbsp;:&nbsp;</p>
<p><u>Avec l’EAC</u></p>
<p>Se connecter à l’EAC puis se rendre dans «&nbsp;<strong>destinataires</strong>&nbsp;» puis onglet «&nbsp;<strong>boites aux lettres</strong>&nbsp;»</p>
<figure class="image"><img src="/images/eac-13.png"></figure>
<p>Pour ajouter une boite aux lettres utilisateur, cliquer sur le <span class="text-huge"><strong>+ </strong></span>et remplir les différents champs.&nbsp;</p>
<figure class="image"><img src="/images/eac-14.png"></figure>
<p>Si l’on souhaite créer des boites aux lettres de groupes, de ressources ou autres, il suffira de reproduire la même chose mais en sélectionnant l’onglet correspondant&nbsp;</p>
<figure class="image"><img src="/images/groups-1.png"></figure>
<p><u>Avec Exchange Management Shell (EMS), voici des exemples&nbsp;:</u></p>
<p><i>New-Mailbox&nbsp;; Set-Mailbox&nbsp;; Enable-Mailbox&nbsp;; Disable-Mailbox&nbsp;; Remove-Mailbox</i><br><i>New-Contact&nbsp;; Set-Contact&nbsp;; Remove-Contact&nbsp;</i><br><i>New-MailUser&nbsp;-Identity «nom» -ExternalEmailAddress «adresse_du_user»&nbsp;; Set-MailUser ; Remove-MailUser&nbsp;</i><br><i>New-Mailbox -Room&nbsp;; New-Mailbox -Equipment</i><br><i>New-Mailbox -Shared</i></p>
<p>Les boites aux lettres de site sont à <strong>activer dans SharePoint</strong></p>
<h2>Personnalisation d’une boite aux lettres</h2>
<h3>Les éléments qui peuvent être personnalisés</h3>
<p>Il existe de nombreux éléments qui peuvent être personnalisés, voici quelques exemples des principaux éléments.</p>
<ul>
  <li>Quota d’une la boite aux lettres utilisateur</li>
</ul>
<p><u>Il y a 3 types de quotas&nbsp;:&nbsp;</u></p>
<p><strong>Avertissement</strong>, lorsque la boite est presque pleine<br><strong>Blocage des mails envoyés</strong>, si la taille de la boite a atteint ce quota l’utilisateur ne pourra plus envoyer de mails<br><strong>Blocage des mails reçus</strong>, si la taille de la boite a atteint ce quota l’utilisateur ne pourra plus recevoir de mails</p>
<ul>
  <li>Désactivation de l’anti-spam</li>
</ul>
<p>Permet de <strong>ne pas filtrer les mails</strong> pour la boite ciblée</p>
<ul>
  <li>Activer la super corbeille de récupération des éléments supprimés de TOUTES les boites aux lettres</li>
</ul>
<p>Permet à un <strong>utilisateur de récupérer lui-même des éléments qui ont été supprimés</strong> de sa boite aux lettres si le délai de rétention des informations n’est pas passé.</p>
<ul>
  <li>Désactiver l’accès mobile ActiveSync d’une groupe de boite aux lettres</li>
</ul>
<p>Permet de <strong>désactiver la possibilité d’accès</strong> à une boite par un utilisateur ou un groupe <strong>depuis un mobile</strong></p>
<ul>
  <li>Désactiver l’accès OWA mobile pour une boite aux lettres</li>
</ul>
<p>Permet de désactiver <strong>l’accès à OWA pour&nbsp; les périphériques mobiles</strong> (tel portable, tablettes, etc.)</p>
<ul>
  <li>Désactiver l’accès Web OWA pour une boite aux lettres</li>
</ul>
<p>Permet de <strong>désactiver la fonction Web</strong> mail pour les utilisateurs. Ils n’auront accès à leurs e-mails que via le lient lourd Outlook.</p>
<ul>
  <li>La taille maximale autorisée d’un e-mail en envoi et réception pour une boite aux lettres</li>
  <li>Le nombre maximal de destinataires autorisés pour un message envoyé depuis une boite aux lettres</li>
</ul>
<p>Permet <strong>d’éviter les envois massifs de mail</strong>. Cette valeur s’applique uniquement à un seul message électronique à la fois.</p>
<ul>
  <li>Réinitialiser le mot de passe de toutes les boites aux lettres utilisateurs à la prochaine connexion</li>
  <li>Le déplacement d’un boite aux lettres vers une autre base de données</li>
</ul>
<p>Dans le cadre d’un <strong>équilibrage de charge</strong> ou si l’on souhaite que les bases de données soient stockées sur <strong>des disques plus rapides que l’existant.</strong></p>
<h3>Comment réaliser ces personnalisations</h3>
<p><u>En mode graphique avec l’EAC</u></p>
<p>Pour modifier les éléments d’une boite mail utilisateur depuis l’EAC il suffit de cliquer sur <strong>destinataires</strong> puis sur <strong>boites aux lettres</strong> et enfin de faire un <strong>double clic</strong> sur la boite mail.</p>
<figure class="image"><img src="/images/eac-15.png"></figure>
<p>Il ne restera plus qu’à <strong>modifier les éléments</strong> souhaités.</p>
<figure class="image"><img src="/images/eac-16.png"></figure>
<p>Faire la même chose avec les groupes, les ressources, les contacts, etc.</p>
<figure class="image"><img src="/images/eac-17.png"></figure>
<p><u>En lignes de commande avec EMS</u></p>
<ul>
  <li>Exemple de mise en place de quota&nbsp;:</li>
</ul>
<pre><code class="language-plaintext">Set-Mailbox -identity «adresse_mail_du_user» -ProhibitSentQuota «taille_en_Gb» -ProhibitReceiveQuota «taille_en_Gb» -IssueWarningQuote «taille_en_Gb»</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Exemple pour désactiver l’antispam&nbsp;:</li>
</ul>
<pre><code class="language-plaintext">Set-Mailbox -identity «adresse_mail» -AntispamBypassEnabled $True</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Activer la super corbeille pour TOUS les utilisateurs (impossible en graphique)</li>
</ul>
<pre><code class="language-plaintext">Get-Mailbox | Set-Mailbox -SingleeltemRecoveryEnabled $True</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Activer la super corbeille pour un utilisateur</li>
</ul>
<pre><code class="language-plaintext">Set-Mailbox -identity «adresse_mail» -SingleeltemRecoveryEnabled $True</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Désactiver l’accès aux boites mails sur mobile pour un groupe d’utilisateurs</li>
</ul>
<pre><code class="language-plaintext">Get-User -Filter «Department -eq «nom_du_groupe_de_users»» | Set-CasMailbox -ActiveSyncEnabled $False</code></pre>
<p><mark class="pen-red"><strong>Attention</strong>&nbsp;</mark><i><mark class="pen-red">les guillemets en jaune sont à laisser dans la commande</mark></i></p>
<ul>
  <li>Désactiver l’accès à la boite mail sur mobile pour un utilisateur</li>
</ul>
<pre><code class="language-plaintext">Set-CasMailbox -Identity «adresse_mail_du_user» -OWAforDevicesEnabled $False</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Désactiver l’accès Web mail pour un utilisateur</li>
</ul>
<pre><code class="language-plaintext">Set-CasMailbox -Identity «adresse_mail_du_user» -OWAEnabled $False</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Modifier la taille maximal d’un message reçu et envoyé pour un utilisateur</li>
</ul>
<pre><code class="language-plaintext">Set-CasMailbox -Identity «adresse_mail_du_user» -MaxReceiveSize «taille_en_Mb» -MaxSendSize «taille_en_Mb»</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Indiquer le nombre maximum de destinataires pour l’envoi d’un message</li>
</ul>
<pre><code class="language-plaintext">Set-CasMailbox -Identity «adresse_mail_du_user» -RecipientsLimits «nombre»</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Activer la réinitialisation du mot de passe de toutes les boites aux lettres utilisateurs à la prochaine connexion</li>
</ul>
<pre><code class="language-plaintext">Get-Mailbox | Set-Mailbox -ResetPasswordOnNextlogon $True</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Activer la réinitialisation du mot de passe d’une boite autre lettres utilisateur à la prochaine connexion</li>
</ul>
<pre><code class="language-plaintext">Set-Mailbox -Identity «adresse_mail_du_user» -ResetPasswordOnNextlogon $True</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Activer le déplacement d’une boite aux lettres vers une nouvelle base de données</li>
</ul>
<pre><code class="language-plaintext">New-MoveMailbox -Identity «adresse_mail» -TargetDatabase «nom_de_la_BDD» -BatchName «nom_de_la_tâche»</code></pre>
<h2>Activer la boite aux lettres d’archivage</h2>
<p><i><mark class="pen-red"><strong>Attention&nbsp;:&nbsp;</strong>Cette fonction ne marche QUE pour les licences CAL de type ENTREPRISE</mark></i></p>
<h3>Les avantages d’une boite aux lettres d’archivage</h3>
<ul>
  <li>Étendre la boite aux lettres d’un utilisateur</li>
  <li>Déplacer automatiquement les anciens messages électroniques vers la boite d’archivage pour faire de la place dans la boite aux lettres.</li>
  <li>Permet d’éviter l’utilisation des fichiers .PST locaux</li>
  <li>Permet de stocker et de sauvegarder les données archivées coté serveur</li>
  <li>Elle peut être montée et être visible dans Outlook</li>
</ul>
<p>La boite d’archivage n’est seulement disponible qu’en mode «&nbsp;Outlook Connecté&nbsp;»</p>
<h3>Activation</h3>
<p><u>Avec l’EAC</u></p>
<p>Pour activer l’archivage depuis l’interface graphique, cliquer sur <strong>destinataires</strong> puis sur <strong>boites aux lettres.</strong><br>Cliquer sur la boite aux lettres d’un utilisateur puis faire défiler les informations de droite jusqu’à atteindre «&nbsp;<strong>archive locale</strong>&nbsp;» et cliquer sur «&nbsp;<strong>activer</strong>&nbsp;»</p>
<figure class="image"><img src="/images/eac-18.png"></figure>
<p>Remplir les informations nécessaires à a configuration</p>
<figure class="image"><img src="/images/eac-19.png"></figure>
<p><u>Avec l’Exchange Management Shell (EMS)</u></p>
<ul>
  <li>Activation de l’archive en même temps que la création d’un compte</li>
</ul>
<pre><code class="language-plaintext">New-Mailbox -UserPrincipalName «adresse_mail_du_user» -Alias «alias_du_user» -Name «nom_du_user» -Database «nom_de_la_BDD» -Archive</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Activer la boite aux lettre d’archive pour une adresse de messagerie. La base de données pour l’archivage sera sélectionnée automatiquement par Exchange</li>
</ul>
<pre><code class="language-plaintext">Enable-Mailbox «adresse_mail_du_user» -Archive</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Activer la boite aux lettre d’archive pour une adresse de messagerie. La base de données pour l’archivage sera celle indiquée dans la commande</li>
</ul>
<pre><code class="language-plaintext">Enable-Mailbox «adresse_mail_du_user» - ArchiveDatabase «nom_de_la_BDD»</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Activer l’utilisation de la boite aux lettre d’archive sur un stockage distant</li>
</ul>
<pre><code class="language-plaintext">Enable-RemoteMailbox «nom_archive» -Archive</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Lister toutes les archives</li>
</ul>
<pre><code class="language-plaintext">Get-Mailbox -Archive</code></pre>
<h2>Délégation de droits de boite aux lettres</h2>
<h3>Pourquoi effectuer une délégation</h3>
<ul>
  <li>Permettre à un ou plusieurs utilisateurs d’accéder à la boite aux lettres d’un autre utilisateur ou groupe.</li>
</ul>
<p>Il faudra ajouter le droit «&nbsp;<strong>FullAccess</strong>&nbsp;» sur la boite aux lettres pour l’utilisateur qui se verra déléguer l’accès.</p>
<ul>
  <li>Permettre à un ou plusieurs utilisateurs d’envoyer des messages électroniques «&nbsp;de la part&nbsp;» du propriétaire de la boite aux lettres.</li>
</ul>
<p>Il faudra ajouter le droit «&nbsp;<strong>SendOnBehalf</strong>&nbsp;» sur la boite aux lettres pour l’utilisateur qui se verra déléguer cette permission.<br>Le <strong>délégué peut envoyer des messages à partir de la boîte aux lettres de l’utilisateur ou du groupe</strong>. L’adresse de ces messages <strong>indique clairement que le message a été envoyé par le délégué</strong>.<br>Toutefois les <strong>réponses</strong> à ces messages sont <strong>envoyées à la boîte aux lettres utilisateur ou du groupe</strong> et non pas au délégué.<br>Cette configuration <strong>n’autorise pas le délégué à lire le contenu de la boîte aux lettres</strong>.</p>
<ul>
  <li>Permettre à un ou plusieurs utilisateurs d’écrire des messages électroniques «&nbsp;en tant que&nbsp;» le propriétaire de la boite aux lettres.</li>
</ul>
<p>Il faudra ajouter le droit «&nbsp;<strong>SendAs</strong>&nbsp;» sur la boite aux lettres pour l’utilisateur qui se verra déléguer cette permission.<br>Cela permet au délégué <strong>d'envoyer des messages comme s'ils provenaient directement de la boîte aux lettres utilisateurs ou du groupe et <u>en son nom</u></strong>. Aucun élément n'indique que le message a été envoyé par le délégué.<br>Cette configuration <strong>n’autorise pas le délégué à lire le contenu de la boîte aux lettres</strong>.</p>
<ul>
  <li>Définir le propriétaire d’une boite de ressource</li>
</ul>
<p>Attention cela ne peut pas s’appliquer sur tous les objets de messagerie. Plus d’informations sur le TechNet.<br>&nbsp;</p>
<h3>Comment effectuer la délégation</h3>
<p><u>A l’aide de l’EAC</u></p>
<p>Se connecter puis cliquer sur «&nbsp;<strong>destinataires</strong>&nbsp;» puis «&nbsp;<strong>boites aux lettre partagée</strong>&nbsp;»<br>Faire un double clic sur la boite aux lettres sur laquelle des droits devront être positionnés puis cliquer sur «&nbsp;<strong>délégation de boite aux lettres</strong>&nbsp;»</p>
<figure class="image"><img src="/images/eac-20.png"></figure>
<p>Dans la liste des types d’accès cliquer sur le <span class="text-huge"><strong>+ </strong></span>et sélectionner le ou les utilisateurs qui ont le type de droit choisi sur cette boite aux lettres.</p>
<p><u>A l’aide de Exchange Management Console (EMS)</u></p>
<ul>
  <li>Ajouter des permissions à une BAL pour des utilisateurs</li>
</ul>
<pre><code class="language-plaintext">Add-MailboxPermission -Identity «adresse_la_BAL_sur_laquelle_on_va_mettre_des_droits» -User «adresse_mail_user_qui_aura_accès» -AccessRights «type_de_droits» -InheritanceType «type_héritage_des_droits_pour_les_dossiers_de_la_BAL» -AutoMapping $True</code></pre>
<p>-AccessRights FullAccess (par exemple)<br>-InheritanceType ALL&nbsp;: indique que TOUS les dossiers de la BAL hériterons des permissions données<br>-AutoMapping $True&nbsp;: map automatiquement la BAL pour le ou les users qui auront les droits</p>
<ul>
  <li>Pour mettre le droit «&nbsp;envoyé de la part de »</li>
</ul>
<pre><code class="language-plaintext">Set-Mailbox -Identity «adresse_la_BAL_sur_laquelle_on_va_mettre_des_droits» -GrantSendOnBehalfTo «adresse_mail_user_qui_aura_accès»</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Pour mettre le droit «&nbsp;envoyé en tant que&nbsp;»</li>
</ul>
<pre><code class="language-plaintext">Get-Mailbox -Identity «adresse_la_BAL_sur_laquelle_on_va_mettre_des_droits» | Add-ADPermission -User «adresse_mail_user_qui_aura_accès» -ExtendedRights «Send AS»</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Pour qu’un utilisateur soit propriétaire d’une ressource</li>
</ul>
<pre><code class="language-plaintext">Add-MailboxPermission -Identity «adresse_la_BAL_Ressource_sur_laquelle_on_va_mettre_des_droits» -Owner «nom_user»</code></pre>
<h2>Listes d’adresses</h2>
<h3>Présentation</h3>
<p>Les listes d’adresses <strong>regroupent des objets</strong> de messagerie <strong>de type de destinataires</strong> en fonctions de différents critères sélectionnés parmi les attributs des comptes Active Directory.<br>Elles permettent de <strong>structurer des utilisateurs</strong> et sont la plupart du temps <strong>utilisées pour représenter virtuellement la structure de l’entreprise</strong> dans ses différents services (par exemple des listes d’adresses par agences ou par site physique).<br>Les listes d’adresses sont <strong>liées à l’organisation Exchange</strong> et peuvent être segmentées logiquement en plusieurs organisations tout en étant visibles ou invisibles par tous les utilisateurs ou une certaine partie des utilisateurs.<br>Une organisation Exchange peut posséder <strong>plusieurs listes d’adresses globales&nbsp;</strong>(<strong>G</strong>lobal <strong>A</strong>ddress <strong>L</strong>ists) comme par exemple dans le cadre d’une mutualisation de l’organisation Exchange.<br>Toutefois un <strong>utilisateur</strong> de messagerie ne peut se voir assigner qu’à <strong>une seule liste</strong> d’adresse globale.</p>
<p><i><mark class="pen-red"><strong>Attention</strong>&nbsp;il ne faut pas confondre avec les groupes de diffusions.</mark></i></p>
<h3>Liste d’adresses par défaut</h3>
<p>Il existe plusieurs types de liste d’adresses par défaut&nbsp;:&nbsp;</p>
<ul>
  <li>Dossiers publics</li>
  <li>Liste d’adresse globale (GAL)</li>
  <li>Tous les contacts</li>
  <li>Tous les groupes</li>
  <li>Tous les utilisateurs</li>
  <li>Toutes les salles</li>
</ul>
<p>Ces listes sont visibles depuis l’EAC dans «&nbsp;<strong>Organisation</strong>&nbsp;» puis «&nbsp;<strong>Listes d’adresses</strong>&nbsp;»</p>
<figure class="image"><img src="/images/eac-21.png"></figure>
<h3>Carnet d’adresses en mode hors connexion</h3>
<p>Le nom du carnet d’adresse est <strong>Offline Address Book (OAB)</strong>. Il n’est présent uniquement pour Outlook et <strong>se télécharge en local</strong> sur le poste utilisateur et contient la liste d’adresse globale par défaut.<br>Son <strong>but</strong> est de permettre aux différents utilisateurs non connectés au serveur de <strong>pouvoir effectuer des recherches dans la liste d’adresse de l’OAB&nbsp;</strong>(qui est par défaut la liste d’adresse globale)<br>Ce carnet d’adresses est généré par une boite de type «&nbsp;<strong>arbitration</strong>&nbsp;» (boite mail qui est uniquement à l’administration de Exchange) dont l’attribut «&nbsp;<strong>OABGen</strong>&nbsp;» est positionné à <strong>$True</strong>. Il peut également y en avoir plusieurs dans une organisation Exchange.</p>
<pre><code class="language-plaintext">Get-Mailbox -Arbitration | Where {$_.PersistedCapabilities -like «*oab*»</code></pre>
<p>Il est <strong>copié sur tous les serveurs d’accès client</strong> de Exchange et est récupéré à l’aide du <strong>répertoire virtuel OAB</strong> depuis les services <strong>Web IIS</strong>.</p>
<h3>Les stratégies de carnet d’adresses</h3>
<p>L’organisation Exchange peut comporter plusieurs stratégies d’adresses mais il ne peut y en avoir qu’une seule attribuée par destinataire de messagerie.<br>Les stratégies de carnet d’adresses permettent de segmenter les vue des listes d’adresses qui sont regroupées dans la GAL.</p>
<p><u>Une stratégie doit comporter les éléments suivants&nbsp;:</u></p>
<ul>
  <li>Une liste d’adresse globale</li>
  <li>Un carnet d’adresse en mode hors connexion</li>
  <li>Des listes d’adresses</li>
  <li>Une liste d’adresses de salles</li>
</ul>
<p>Les listes d’adresses sont visibles dans l’EAC dans la section «&nbsp;organisation&nbsp;» puis «&nbsp;listes d’adresses&nbsp;»</p>
<figure class="image"><img src="/images/eac-22.png"></figure>
<p>Il est possible de les créer via EAC ou EMS.</p>
<p><u>Création à l’aide de EAC&nbsp;:</u></p>
<p>Se connecter à l’EAC&nbsp;, cliquer sur «&nbsp;organisation&nbsp;» puis «&nbsp;listes d’adresses&nbsp;».<br>Cliquer sur le bouton + et renseigner les informations nécessaires en prenant soin de respecter les éléments précédemment cités.</p>
<figure class="image"><img src="/images/eac-23.png"></figure>
<p>Pour ajouter la liste qui a été créée à un utilisateur, il faut aller dans la section «&nbsp;destinataires&nbsp;» puis cliquer sur le nom de l’utilisateur ciblé.</p>
<figure class="image"><img src="/images/eac-24.png"></figure>
<p>Une nouvelle fenêtre s’ouvre. Cliquer sur «&nbsp;fonctionnalités de boite aux lettres&nbsp;» puis dans la section «&nbsp;stratégie du carnet d’adresses&nbsp;» sélectionner la stratégie à appliquer.</p>
<figure class="image"><img src="/images/eac-25.png"></figure>
<p>Cliquer sur «&nbsp;enregistrer&nbsp;» pour valider.</p>
<p><u>Création à l’aide de EMS&nbsp;:</u></p>
<pre><code class="language-plaintext">New-AddressBookPolicy -Name «nom_de_la_stratégie» -AddressLists «\nom_de_la_liste_d’adresses» -Roomlist «\nom_de_la_liste_de_salles» -OfflineAddressBook «\nom_carnet_OAB» -GlobalAddresslist «\nom_de_la_GAL»</code></pre>
<p>Elles sont attribuées aux boites aux lettres utilisateurs via <u>EMS</u>&nbsp;:&nbsp;</p>
<pre><code class="language-plaintext">Set-Mailbox -Identity «adresse_mail_du_user» -AddressBookPolicy «nom_de_la_stratégie»</code></pre>
<h2>Haute disponibilité - D.A.G</h2>
<h3>Définition</h3>
<p>La haute disponibilité des bases de données dans Exchange s’effectue à l’aide d’un <strong>DAG</strong>.<br>Ce terme signifie «&nbsp;<strong>Database Availability Group</strong>&nbsp;» ou en français « <strong>Groupe de disponibilité de base de données</strong> ».<br>Il assure pour cela une <strong>redondance</strong> au niveau du «&nbsp;<strong>BACK-END</strong>&nbsp;».<br>Son principe de fonctionnement est simple : il réplique des bases de données sur un <strong>regroupement plusieurs serveurs Exchange</strong> ayant <strong>le rôle de boites aux lettres</strong> pour en effectuer la <strong>haute disponibilité</strong> pour de prévenir les pannes ou les coupures de service potentielles. Ce qui veut dire que les serveurs Exchange peuvent ainsi récupérer automatiquement des bases de données à la suite d’une panne d’un serveur ou lorsqu’une base de données n’est plus accessible.</p>
<p>Un DAG se base sur le service de «&nbsp;<strong>Cluster</strong>&nbsp;» de Windows Serveur mais ne peut pas être géré par les outils de Cluster de basculement de Windows Server.<br>Lorsque la création d’un DAG est initiée, les rôles et fonctionnalités de cluster sont installés <strong>sur chaque nœud</strong> qui en fait partie.<br>Pour mettre en place un DAG, il faut tenir compte des points suivants&nbsp;:&nbsp;</p>
<ul>
  <li>Les membres du DAG doivent avoir <strong>le même système d’exploitation</strong></li>
  <li>La <strong>même version d’Exchange</strong> doit être utilisée sur chacun des nœuds du DAG</li>
  <li>Le <strong>DAG se limite à 16 copies de base de données</strong>, en comptant la copie active (1 copie active et 15 copies passives)</li>
  <li>Il n’est plus obligatoire depuis Exchange 2016 que le DAG possède une adresse IP et aucune configuration DNS n’est à prévoir</li>
  <li>Le nom du DAG doit être <strong>unique</strong> au sein de l’organisation Exchange</li>
  <li>Pour fonctionner un DAG, dont le nombre de nœuds dans le Cluster est pair, a besoin d’un <strong>serveur «&nbsp;témoin&nbsp;»</strong> (qui doit être <u>hors du DAG</u>) avec un partage de fichiers effectué depuis un répertoire précis</li>
</ul>
<p>Le «&nbsp;serveur témoin&nbsp;» (Witness Server en anglais) assure la cohérence, le départage et le temps de réponse du Cluster. Ce serveur doit être dans domaine que les serveurs Exchange.<br>Il se base sur le composant «&nbsp;<strong>Active Manager</strong>&nbsp;».</p>
<p>Ce composant comprend&nbsp;:&nbsp;</p>
<ul>
  <li>Le gestionnaire <strong>Active Manager Principal (PAM)</strong> dont le rôle est de déterminer quelles copies de bases de données seront actives ou passives</li>
  <li>Le gestionnaire <strong>Active Manager de secours (SAM)</strong> qui communique l’état des bases de données aux autres membres du DAG ainsi que le serveur témoin. Il établit également la santé de chaque base de données.</li>
</ul>
<p>Il est tout à fait <strong>possible que le&nbsp;«&nbsp;serveur témoin&nbsp;» fasse partie de plusieurs DAG</strong> mais il faudra dans ce cas utiliser différents répertoires de partage pour les différents DAG.<br>Le <strong>quorum</strong> (majorité) d’un cluster est déterminé par le <strong>nombre d’éléments votants</strong>. Ces éléments doivent faire partie des <strong>membres actifs</strong> du Cluster pour permettre à ce dernier de démarrer correctement ou de continuer à s’exécuter.<br>Par défaut, chaque nœud du Cluster dispose <strong>d’un seul vote</strong> de quorum. Toutefois, un «&nbsp;serveur témoin&nbsp;» dispose d’un vote de quorum supplémentaire.<br>Chaque élément peut donc « voter » pour déterminer si le Cluster peut s’exécuter. Pour atteindre le quorum et fonctionner correctement un Cluster doit recueillir <strong>la majoritédes votes</strong> parmi les membres actifs du Cluster, raison pour laquelle il est nécessaire d’avoir un «&nbsp;serveur témoin&nbsp;» si le nombre de serveurs membres est pair.</p>
<p><u>Schéma&nbsp;:&nbsp;</u></p>
<figure class="image"><img src="/images/schema_dag.png"></figure>
<p><i><mark class="pen-red"><strong>Attention</strong>&nbsp;dans ce schéma une seule carte réseau n’est illustrée mais il est conseillé d’avoir 2 cartes réseau sur les serveurs du DAG afin de séparer les flux de réplications et flux normaux d’utilisations par les utilisateurs. </mark></i><mark class="pen-red">Lors de la mise en place de la haute disponibilité sur Exchange, les données des copies de bases de données seront stockées aux mêmes emplacements sur chacun des membres du DAG les détenant.</mark></p>
<h3>Les actions de la configuration</h3>
<p><u>Ce qui est obligatoire&nbsp;:</u></p>
<ul>
  <li>Créer un DAG</li>
  <li>Ajouter des membres au DAG</li>
  <li>Ajouter des copies des bases de données sur les serveurs qui n’héberge pas ces boites de données.</li>
</ul>
<p>Il est possible de définir quels seront les serveurs qui auront les copies, il n’est pas obligatoire de mettre des copies sur TOUS LES serveurs.</p>
<p><u>Ce qui est optionnel&nbsp;:</u></p>
<ul>
  <li>Utilisation d’un «&nbsp;serveur témoin&nbsp;» (selon le nombre de serveurs dans le DAG, pour pouvoir valider le quorum)</li>
  <li>Configuration des préférences d’activation des copies de bases de données (quel serveurs auront quelles copies)</li>
  <li>Configuration des copies de bases de données avec un délai d’attente de la troncation des fichiers de logs après l’écriture en base de données (permet d’avoir une version «&nbsp;décalée&nbsp;» à J-x des bases de données)</li>
  <li>Configuration des copies de bases de données avec un retard de lecture</li>
  <li>Configuration d’un réseau dédié à la réplication (toutefois conseillé)</li>
</ul>
<h3>La configuration du DAG</h3>
<p>La configuration d’un DAG peut se faire soit via l’EAC soit via l’EMS</p>
<p><u>Via l’EAC&nbsp;:</u></p>
<p>Se connecter à l’EAC puis dans la partie «&nbsp;serveur&nbsp;» cliquer sur «&nbsp;Groupe de disponibilité de bases de données&nbsp;»</p>
<figure class="image"><img src="/images/eac-26.png"></figure>
<p>Cliquer sur le bouton <span class="text-huge"><strong>+ </strong></span>et renseigner les informations demandées.</p>
<figure class="image"><img src="/images/eac-27.png"></figure>
<p>Le nom du serveur témoin doit être écrit en FQDN<br>Il n’est pas obligatoire d’utiliser une adresse IP pour le DAG si et seulement si les serveurs membres du DAG sont en version Windows Server 2012 R2 et supérieures.<br>Dans le cas contraire il faudra ajouter une adresse IP</p>
<p>Cliquer sur «&nbsp;enregistrer&nbsp;» et le DAG sera créé. Pour l’instant il ne possède aucun membres.</p>
<figure class="image"><img src="/images/eac-28.png"></figure>
<p>Pour ajouter des membres, sélectionner le DAG puis cliquer sur l’icone<br>Cliquer sur le bouton <span class="text-huge"><strong>+ </strong></span>et sélectionner les serveurs qui deviendrons membres du DAG</p>
<figure class="image"><img src="/images/eac-29.png"></figure>
<p>Pour ajouter des copies de bases de données sur les serveurs du DAG, il faut se rendre toujours dans «&nbsp;serveurs&nbsp;» puis dans la section «&nbsp;base de données&nbsp;»</p>
<figure class="image"><img src="/images/eac-30.png"></figure>
<p>Sélectionner une base de données puis cliquer sur le symbole «&nbsp;…&nbsp;» puis cliquer sur «&nbsp;ajouter une copie de base de données</p>
<figure class="image"><img src="/images/eac-31.png"></figure>
<p>Une nouvelle fenêtre s’ouvre permettant de choisir le serveur qui hébergera la copie de la base de données précédemment sélectionnée.</p>
<figure class="image"><img src="/images/eac-32.png"></figure>
<p>Pour terminer la copie, cliquer sur enregistrer.</p>
<p><u>Via l’EMS&nbsp;:</u></p>
<ul>
  <li>Commande pour créer un DAG</li>
</ul>
<pre><code class="language-plaintext">New-DatabaseAvailabilityGroup -Name «nom_du_DAG» -WitnessServer «nom_du_serveur_témoin» -WitnessDirecory «chemin_du_répertoire_partagé_depuis_le_serveur_témoin»</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Ajout d’un serveur membre au DAG</li>
</ul>
<pre><code class="language-plaintext">Add- DatabaseAvailabilityGroupServer -Identity «nom_du_DAG» -MailboxServer «nom_du_server»</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Ajout de copie de bases de données sur des serveurs membres du DAG</li>
</ul>
<pre><code class="language-plaintext">Add-MailboxDatabaseCopy -Identity «nom_de_la_BDD_a_copier» -MailboxServer «nom_du_server_qui_aura_la_copie» -ActivationPreference «N°_de_préférence»</code></pre>
<p><strong>ActivationPreference&nbsp;</strong>: il s’agit ici d’entrer un numéro qui permettra de définir l’ordre de préférence d’activation de la copie. Par exemple si on met «&nbsp;2&nbsp;» dans ce cas le serveur sera le 2<sup>ème&nbsp;</sup> préféré pour activer la copie en cas de problème avec la BDD d’origine.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
